---
title: async/await
date: 2022-09-05 09:46:47
permalink: /pages/946c25/
categories:
  - å‰ç«¯ä¹±ç‚–
  - JavaScript
tags:
  - ES6
author:
  name: peng
  link: https://github.com/lp-Imagine
---

JavaScript ä¸­çš„ async/await æ˜¯ AsyncFunction ç‰¹æ€§ ä¸­çš„å…³é”®å­—ã€‚ç›®å‰ä¸ºæ­¢ï¼Œé™¤äº† IE ä¹‹å¤–ï¼Œå¸¸ç”¨æµè§ˆå™¨å’Œ Node (v7.6+) éƒ½å·²ç»æ”¯æŒè¯¥ç‰¹æ€§ã€‚å…·ä½“æ”¯æŒæƒ…å†µå¯ä»¥åœ¨[è¿™é‡Œ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/AsyncFunction#Browser_compatibility)æŸ¥çœ‹ã€‚

<!-- more -->

## async å’Œ await åœ¨å¹²ä»€ä¹ˆ

ä»»æ„ä¸€ä¸ªåç§°éƒ½æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå…ˆä»å­—é¢æ„æ€æ¥ç†è§£ã€‚async æ˜¯â€œå¼‚æ­¥â€çš„ç®€å†™ï¼Œè€Œ await å¯ä»¥è®¤ä¸ºæ˜¯ async wait çš„ç®€å†™ã€‚æ‰€ä»¥åº”è¯¥å¾ˆå¥½ç†è§£ async ç”¨äºç”³æ˜ä¸€ä¸ª function æ˜¯å¼‚æ­¥çš„ï¼Œè€Œ await ç”¨äºç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæˆã€‚

å¦å¤–è¿˜æœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯­æ³•è§„å®šï¼Œawait åªèƒ½å‡ºç°åœ¨ async å‡½æ•°ä¸­ã€‚ç„¶åç»†å¿ƒçš„æœ‹å‹ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœ await åªèƒ½å‡ºç°åœ¨ async å‡½æ•°ä¸­ï¼Œé‚£è¿™ä¸ª async å‡½æ•°åº”è¯¥æ€ä¹ˆè°ƒç”¨ï¼Ÿ

å¦‚æœéœ€è¦é€šè¿‡ await æ¥è°ƒç”¨ä¸€ä¸ª async å‡½æ•°ï¼Œé‚£è¿™ä¸ªè°ƒç”¨çš„å¤–é¢å¿…é¡»å¾—å†åŒ…ä¸€ä¸ª async å‡½æ•°ï¼Œç„¶åâ€¦â€¦è¿›å…¥æ­»å¾ªç¯ï¼Œæ°¸æ— å‡ºå¤´ä¹‹æ—¥â€¦â€¦

å¦‚æœ async å‡½æ•°ä¸éœ€è¦ await æ¥è°ƒç”¨ï¼Œé‚£ async åˆ°åº•èµ·ä¸ªå•¥ä½œç”¨ï¼Ÿ

### async èµ·ä»€ä¹ˆä½œç”¨

è¿™ä¸ªé—®é¢˜çš„å…³é”®åœ¨äºï¼Œasync å‡½æ•°æ˜¯æ€ä¹ˆå¤„ç†å®ƒçš„è¿”å›å€¼çš„ï¼

æˆ‘ä»¬å½“ç„¶å¸Œæœ›å®ƒèƒ½ç›´æ¥é€šè¿‡ return è¯­å¥è¿”å›æˆ‘ä»¬æƒ³è¦çš„å€¼ï¼Œä½†æ˜¯å¦‚æœçœŸæ˜¯è¿™æ ·ï¼Œä¼¼ä¹å°±æ²¡ await ä»€ä¹ˆäº‹äº†ã€‚æ‰€ä»¥ï¼Œå†™æ®µä»£ç æ¥è¯•è¯•ï¼Œçœ‹å®ƒåˆ°åº•ä¼šè¿”å›ä»€ä¹ˆï¼š

```javascript
async function testAsync() {
  return "hello async";
}

const result = testAsync();
console.log(result);
```

çœ‹åˆ°è¾“å‡ºå°±æç„¶å¤§æ‚Ÿäº†â€”â€”è¾“å‡ºçš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚

![](https://cdn.jsdelivr.net/gh/lp-Imagine/lp-Imagine@main/images/async_log.png)

æ‰€ä»¥ï¼Œasync å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚ä»[æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)ä¸­ä¹Ÿå¯ä»¥å¾—åˆ°è¿™ä¸ªä¿¡æ¯ã€‚async å‡½æ•°ï¼ˆåŒ…å«å‡½æ•°è¯­å¥ã€å‡½æ•°è¡¨è¾¾å¼ã€Lambda è¡¨è¾¾å¼ï¼‰ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœåœ¨å‡½æ•°ä¸­ return ä¸€ä¸ªç›´æ¥é‡ï¼Œasync ä¼šæŠŠè¿™ä¸ªç›´æ¥é‡é€šè¿‡ Promise.resolve() å°è£…æˆ Promise å¯¹è±¡ã€‚

Promise.resolve(x)å¯ä»¥çœ‹ä½œæ˜¯ new Promise(resolve => resolve(x))çš„ç®€å†™ï¼Œå¯ä»¥ç”¨äºå¿«é€Ÿå°è£…å­—é¢é‡å¯¹è±¡æˆ–å…¶ä»–å¯¹è±¡ï¼Œå°†å…¶å°è£…æˆ Promise å®ä¾‹ã€‚

async å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨æœ€å¤–å±‚ä¸èƒ½ç”¨ await è·å–å…¶è¿”å›å€¼çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å½“ç„¶åº”è¯¥ç”¨åŸæ¥çš„æ–¹å¼ï¼šthen()é“¾æ¥å¤„ç†è¿™ä¸ª Promise å¯¹è±¡ï¼Œå°±åƒè¿™æ ·

```javascript
testAsync().then((v) => {
  console.log(v); // è¾“å‡º hello async
});
```

ç°åœ¨å›è¿‡å¤´æ¥æƒ³ä¸‹ï¼Œå¦‚æœ async å‡½æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œåˆè¯¥å¦‚ä½•ï¼Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå®ƒä¼šè¿”å› Promise.resolve(undefined)ã€‚

è”æƒ³ä¸€ä¸‹ Promise çš„ç‰¹ç‚¹â€”â€”æ— ç­‰å¾…ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰ await çš„æƒ…å†µä¸‹æ‰§è¡Œ async å‡½æ•°ï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œï¼Œè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¹¶ä¸”ï¼Œç»ä¸ä¼šé˜»å¡åé¢çš„è¯­å¥ã€‚è¿™å’Œæ™®é€šè¿”å› Promise å¯¹è±¡çš„å‡½æ•°å¹¶æ— äºŒè‡´ã€‚

é‚£ä¹ˆä¸‹ä¸€ä¸ªå…³é”®ç‚¹å°±åœ¨äº await å…³é”®å­—äº†ã€‚

### await åˆ°åº•åœ¨ç­‰å•¥

ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½è®¤ä¸º await æ˜¯åœ¨ç­‰å¾…ä¸€ä¸ª async å‡½æ•°å®Œæˆã€‚ä¸è¿‡æŒ‰è¯­æ³•è¯´æ˜ï¼Œawait ç­‰å¾…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœæ˜¯ Promise å¯¹è±¡æˆ–è€…å…¶å®ƒå€¼ï¼ˆæ¢å¥è¯è¯´ï¼Œå°±æ˜¯æ²¡æœ‰ç‰¹æ®Šé™å®šï¼‰ã€‚

å› ä¸º async å‡½æ•°è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥ await å¯ä»¥ç”¨äºç­‰å¾…ä¸€ä¸ª async å‡½æ•°çš„è¿”å›å€¼â€”â€”è¿™ä¹Ÿå¯ä»¥è¯´æ˜¯ await åœ¨ç­‰ async å‡½æ•°ï¼Œä½†è¦æ¸…æ¥šï¼Œå®ƒç­‰çš„å®é™…æ˜¯ä¸€ä¸ªè¿”å›å€¼ã€‚æ³¨æ„åˆ° await ä¸ä»…ä»…ç”¨äºç­‰ Promise å¯¹è±¡ï¼Œå®ƒå¯ä»¥ç­‰ä»»æ„è¡¨è¾¾å¼çš„ç»“æœï¼Œæ‰€ä»¥ï¼Œawait åé¢å®é™…æ˜¯å¯ä»¥æ¥æ™®é€šå‡½æ•°è°ƒç”¨æˆ–è€…ç›´æ¥é‡çš„ã€‚æ‰€ä»¥ä¸‹é¢è¿™ä¸ªç¤ºä¾‹å®Œå…¨å¯ä»¥æ­£ç¡®è¿è¡Œ

```javascript
function getSomething() {
  return "something";
}

async function testAsync() {
  return Promise.resolve("hello async");
}

async function test() {
  const v1 = await getSomething();
  const v2 = await testAsync();
  console.log(v1, v2);
}

test();
```

### await ç­‰åˆ°äº†è¦ç­‰çš„ï¼Œç„¶åå‘¢

await ç­‰åˆ°äº†å®ƒè¦ç­‰çš„ä¸œè¥¿ï¼Œä¸€ä¸ª Promise å¯¹è±¡ï¼Œæˆ–è€…å…¶å®ƒå€¼ï¼Œç„¶åå‘¢ï¼Ÿæˆ‘ä¸å¾—ä¸å…ˆè¯´ï¼Œawait æ˜¯ä¸ªè¿ç®—ç¬¦ï¼Œç”¨äºç»„æˆè¡¨è¾¾å¼ï¼Œawait è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå–å†³äºå®ƒç­‰çš„ä¸œè¥¿ã€‚

å¦‚æœå®ƒç­‰åˆ°çš„ä¸æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå°±æ˜¯å®ƒç­‰åˆ°çš„ä¸œè¥¿ã€‚

å¦‚æœå®ƒç­‰åˆ°çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œawait å°±å¿™èµ·æ¥äº†ï¼Œå®ƒä¼šé˜»å¡åé¢çš„ä»£ç ï¼Œç­‰ç€ Promise å¯¹è±¡ resolveï¼Œç„¶åå¾—åˆ° resolve çš„å€¼ï¼Œä½œä¸º await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœã€‚

çœ‹åˆ°ä¸Šé¢çš„é˜»å¡ä¸€è¯ï¼Œå¿ƒæ…Œäº†å§â€¦â€¦æ”¾å¿ƒï¼Œè¿™å°±æ˜¯ await å¿…é¡»ç”¨åœ¨ async å‡½æ•°ä¸­çš„åŸå› ã€‚async å‡½æ•°è°ƒç”¨ä¸ä¼šé€ æˆé˜»å¡ï¼Œå®ƒå†…éƒ¨æ‰€æœ‰çš„é˜»å¡éƒ½è¢«å°è£…åœ¨ä¸€ä¸ª Promise å¯¹è±¡ä¸­å¼‚æ­¥æ‰§è¡Œã€‚

---

## async/await å¸®æˆ‘ä»¬å¹²äº†å•¥

### ä½œä¸ªç®€å•çš„æ¯”è¾ƒ

ä¸Šé¢å·²ç»è¯´æ˜äº† async ä¼šå°†å…¶åçš„å‡½æ•°ï¼ˆå‡½æ•°è¡¨è¾¾å¼æˆ– Lambdaï¼‰çš„è¿”å›å€¼å°è£…æˆä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œ await ä¼šç­‰å¾…è¿™ä¸ª Promise å®Œæˆï¼Œå¹¶å°†å…¶ resolve çš„ç»“æœè¿”å›å‡ºæ¥ã€‚

ç°åœ¨ä¸¾ä¾‹ ğŸŒ°ï¼Œç”¨ setTimeout æ¨¡æ‹Ÿè€—æ—¶çš„å¼‚æ­¥æ“ä½œï¼Œå…ˆæ¥çœ‹çœ‹ä¸ç”¨ async/await ä¼šæ€ä¹ˆå†™

```javascript
function takeLongTime() {
  return new Promise((resolve) => {
    setTimeout(() => resolve("long_time_value"), 1000);
  });
}

takeLongTime().then((v) => {
  console.log("got", v);
});
```

å¦‚æœæ”¹ç”¨ async/await å‘¢ï¼Œä¼šæ˜¯è¿™æ ·

```javascript
function takeLongTime() {
  return new Promise((resolve) => {
    setTimeout(() => resolve("long_time_value"), 1000);
  });
}

async function test() {
  const v = await takeLongTime();
  console.log(v);
}

test();
```

çœ¼å°–çš„åŒå­¦å·²ç»å‘ç° takeLongTime() æ²¡æœ‰ç”³æ˜ä¸º asyncã€‚å®é™…ä¸Šï¼ŒtakeLongTime() æœ¬èº«å°±æ˜¯è¿”å›çš„ Promise å¯¹è±¡ï¼ŒåŠ ä¸åŠ  async ç»“æœéƒ½ä¸€æ ·ï¼Œå¦‚æœæ²¡æ˜ç™½ï¼Œè¯·å›è¿‡å¤´å†å»çœ‹çœ‹ä¸Šé¢çš„â€œasync èµ·ä»€ä¹ˆä½œç”¨â€ã€‚

åˆä¸€ä¸ªç–‘é—®äº§ç”Ÿäº†ï¼Œè¿™ä¸¤æ®µä»£ç ï¼Œä¸¤ç§æ–¹å¼å¯¹å¼‚æ­¥è°ƒç”¨çš„å¤„ç†ï¼ˆå®é™…å°±æ˜¯å¯¹ Promise å¯¹è±¡çš„å¤„ç†ï¼‰å·®åˆ«å¹¶ä¸æ˜æ˜¾ï¼Œç”šè‡³ä½¿ç”¨ async/await è¿˜éœ€è¦å¤šå†™ä¸€äº›ä»£ç ï¼Œé‚£å®ƒçš„ä¼˜åŠ¿åˆ°åº•åœ¨å“ªï¼Ÿ

### async/await çš„ä¼˜åŠ¿åœ¨äºå¤„ç† then é“¾

å•ä¸€çš„ Promise é“¾å¹¶ä¸èƒ½å‘ç° async/await çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯ï¼Œå¦‚æœéœ€è¦å¤„ç†ç”±å¤šä¸ª Promise ç»„æˆçš„ then é“¾çš„æ—¶å€™ï¼Œä¼˜åŠ¿å°±èƒ½ä½“ç°å‡ºæ¥äº†ï¼ˆå¾ˆæœ‰æ„æ€ï¼ŒPromise é€šè¿‡ then é“¾æ¥è§£å†³å¤šå±‚å›è°ƒçš„é—®é¢˜ï¼Œç°åœ¨åˆç”¨ async/await æ¥è¿›ä¸€æ­¥ä¼˜åŒ–å®ƒï¼‰ã€‚

å‡è®¾ä¸€ä¸ªä¸šåŠ¡ï¼Œåˆ†å¤šä¸ªæ­¥éª¤å®Œæˆï¼Œæ¯ä¸ªæ­¥éª¤éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”ä¾èµ–äºä¸Šä¸€ä¸ªæ­¥éª¤çš„ç»“æœã€‚æˆ‘ä»¬ä»ç„¶ç”¨ setTimeout æ¥æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œï¼š

```javascript
/**
 * ä¼ å…¥å‚æ•° nï¼Œè¡¨ç¤ºè¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * æ‰§è¡Œçš„ç»“æœæ˜¯ n + 200ï¼Œè¿™ä¸ªå€¼å°†ç”¨äºä¸‹ä¸€æ­¥éª¤
 */
function takeLongTime(n) {
  return new Promise((resolve) => {
    setTimeout(() => resolve(n + 200), n);
  });
}

function step1(n) {
  console.log(`step1 with ${n}`);
  return takeLongTime(n);
}

function step2(n) {
  console.log(`step2 with ${n}`);
  return takeLongTime(n);
}

function step3(n) {
  console.log(`step3 with ${n}`);
  return takeLongTime(n);
}
```

ç°åœ¨ç”¨ Promise æ–¹å¼æ¥å®ç°è¿™ä¸‰ä¸ªæ­¥éª¤çš„å¤„ç†

```javascript
function doIt() {
  console.time("doIt");
  const time1 = 300;
  step1(time1)
    .then((time2) => step2(time2))
    .then((time3) => step3(time3))
    .then((result) => {
      console.log(`result is ${result}`);
      console.timeEnd("doIt");
    });
}

doIt();

// c:\var\test>node --harmony_async_await .
// step1 with 300
// step2 with 500
// step3 with 700
// result is 900
// doIt: 1507.251ms
```

è¾“å‡ºç»“æœ result æ˜¯ step3()çš„å‚æ•° 700 + 200 = 900ã€‚doIt()é¡ºåºæ‰§è¡Œäº†ä¸‰ä¸ªæ­¥éª¤ï¼Œä¸€å…±ç”¨äº† 300 + 500 + 700 = 1500 æ¯«ç§’ï¼Œå’Œ console.time()/console.timeEnd()è®¡ç®—çš„ç»“æœä¸€è‡´ã€‚

å¦‚æœç”¨ async/await æ¥å®ç°å‘¢ï¼Œä¼šæ˜¯è¿™æ ·

```javascript
async function doIt() {
  console.time("doIt");
  const time1 = 300;
  const time2 = await step1(time1);
  const time3 = await step2(time2);
  const result = await step3(time3);
  console.log(`result is ${result}`);
  console.timeEnd("doIt");
}

doIt();
```

ç»“æœå’Œä¹‹å‰çš„ Promise å®ç°æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è¿™ä¸ªä»£ç çœ‹èµ·æ¥æ˜¯ä¸æ˜¯æ¸…æ™°å¾—å¤šï¼Œå‡ ä¹è·ŸåŒæ­¥ä»£ç ä¸€æ ·

### è¿˜æœ‰æ›´é…·çš„

ç°åœ¨æŠŠä¸šåŠ¡è¦æ±‚æ”¹ä¸€ä¸‹ï¼Œä»ç„¶æ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼Œä½†æ¯ä¸€ä¸ªæ­¥éª¤éƒ½éœ€è¦ä¹‹å‰æ¯ä¸ªæ­¥éª¤çš„ç»“æœã€‚

```javascript
function step1(n) {
  console.log(`step1 with ${n}`);
  return takeLongTime(n);
}

function step2(m, n) {
  console.log(`step2 with ${m} and ${n}`);
  return takeLongTime(m + n);
}

function step3(k, m, n) {
  console.log(`step3 with ${k}, ${m} and ${n}`);
  return takeLongTime(k + m + n);
}
```

è¿™å›å…ˆç”¨ async/await æ¥å†™ï¼š

```javascript
async function doIt() {
  console.time("doIt");
  const time1 = 300;
  const time2 = await step1(time1);
  const time3 = await step2(time1, time2);
  const result = await step3(time1, time2, time3);
  console.log(`result is ${result}`);
  console.timeEnd("doIt");
}

doIt();

// c:\var\test>node --harmony_async_await .
// step1 with 300
// step2 with 800 = 300 + 500
// step3 with 1800 = 300 + 500 + 1000
// result is 2000
// doIt: 2907.387ms
```

é™¤äº†è§‰å¾—æ‰§è¡Œæ—¶é—´å˜é•¿äº†ä¹‹å¤–ï¼Œä¼¼ä¹å’Œä¹‹å‰çš„ç¤ºä¾‹æ²¡å•¥åŒºåˆ«å•Šï¼åˆ«æ€¥ï¼Œè®¤çœŸæƒ³æƒ³å¦‚æœæŠŠå®ƒå†™æˆ Promise æ–¹å¼å®ç°ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿ

```javascript
function doIt() {
  console.time("doIt");
  const time1 = 300;
  step1(time1)
    .then((time2) => {
      return step2(time1, time2).then((time3) => [time1, time2, time3]);
    })
    .then((times) => {
      const [time1, time2, time3] = times;
      return step3(time1, time2, time3);
    })
    .then((result) => {
      console.log(`result is ${result}`);
      console.timeEnd("doIt");
    });
}

doIt();
```

è½¬è½½è‡ªï¼š[è¾¹åŸ](https://segmentfault.com/u/jamesfancy)çš„[ç†è§£ JavaScript çš„ async/await](https://segmentfault.com/a/1190000007535316)
ç›¸å…³æ–‡ç« ï¼š
[åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ async/await](https://segmentfault.com/a/1190000021966277)
[ä»£ç å®¡æŸ¥ï¼Œå¼‚æ­¥è°ƒç”¨çš„å¸¸è§é—®é¢˜å‰–æ](https://segmentfault.com/a/1190000022349639)
[Proxy å°è£…å¾®ä¿¡å°ç¨‹åºçš„å¼‚æ­¥è°ƒç”¨](https://segmentfault.com/a/1190000022315137)
[æ”¹è¿›å¼‚æ­¥å°è£…ï¼šå¤„ç†å¸¦è¿”å›å€¼çš„å¼‚æ­¥è°ƒç”¨](https://segmentfault.com/a/1190000022467002)
[ä»ä¸ç”¨ try-catch å®ç°çš„ async/await è¯­æ³•è¯´é”™è¯¯å¤„ç†](https://segmentfault.com/a/1190000011802045)
