---
title: Axios å°è£…
date: 2022-09-06 15:42:22
permalink: /pages/b63ee9/
categories:
  - å‰ç«¯ä¹±ç‚–
  - JavaScript
tags:
  - JavaScript
author:
  name: peng
  link: https://github.com/lp-Imagine
---

## axios çš„å°è£…

åœ¨ vue é¡¹ç›®ä¸­ï¼Œå’Œåå°äº¤äº’è·å–æ•°æ®è¿™å—ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ˜¯ `axios` åº“ï¼Œå®ƒæ˜¯åŸºäº `promise` çš„ `http` åº“ï¼Œå¯è¿è¡Œåœ¨æµè§ˆå™¨ç«¯å’Œ `node.js` ä¸­ã€‚ä»–æœ‰å¾ˆå¤šä¼˜ç§€çš„ç‰¹æ€§ï¼Œä¾‹å¦‚æ‹¦æˆªè¯·æ±‚å’Œå“åº”ã€å–æ¶ˆè¯·æ±‚ã€è½¬æ¢ `json`ã€å®¢æˆ·ç«¯é˜²å¾¡ `XSRF` ç­‰ã€‚æ‰€ä»¥æˆ‘ä»¬çš„å°¤å¤§å¤§ä¹Ÿæ˜¯æœæ–­æ”¾å¼ƒäº†å¯¹å…¶å®˜æ–¹åº“[vue-resource](https://www.runoob.com/vue2/vuejs-ajax.html)çš„ç»´æŠ¤ï¼Œç›´æ¥æ¨èæˆ‘ä»¬ä½¿ç”¨ `axios` åº“ã€‚å¦‚æœè¿˜å¯¹ `axios` ä¸äº†è§£çš„ï¼Œå¯ä»¥ç§»æ­¥[axios æ–‡æ¡£](http://www.axios-js.com/)ã€‚

<!-- more -->

### å®‰è£…

```javascript
npm install axios; // å®‰è£…axios
```

### å¼•å…¥

åœ¨é¡¹ç›®çš„ `src` ç›®å½•ä¸­ï¼Œæ–°å»ºä¸€ä¸ª `request` æ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨é‡Œé¢æ–°å»ºä¸€ä¸ª `http.js` å’Œä¸€ä¸ª `api.js` æ–‡ä»¶ã€‚`http.js` æ–‡ä»¶ç”¨æ¥å°è£…æˆ‘ä»¬çš„ `axios`ï¼Œ`api.js` ç”¨æ¥ç»Ÿä¸€ç®¡ç†æˆ‘ä»¬çš„æ¥å£ã€‚

```javascript
// åœ¨http.jsä¸­å¼•å…¥axios
import axios from "axios"; // å¼•å…¥axios
import QS from "qs"; // å¼•å…¥qsæ¨¡å—ï¼Œç”¨æ¥åºåˆ—åŒ–postç±»å‹çš„æ•°æ®
// elementçš„messageæç¤ºæ¡†ç»„ä»¶ï¼Œå¯æ ¹æ®è‡ªå·±çš„uiç»„ä»¶æ›´æ”¹ã€‚
import { Message } from "element-ui";
```

### ç¯å¢ƒçš„åˆ‡æ¢

é¡¹ç›®ç¯å¢ƒå¯èƒ½æœ‰å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚éœ€è¦é€šè¿‡ `node` çš„ç¯å¢ƒå˜é‡æ¥åŒ¹é…é»˜è®¤çš„æ¥å£ `url` å‰ç¼€ã€‚`axios.defaults.baseURL` å¯ä»¥è®¾ç½® `axios` çš„é»˜è®¤è¯·æ±‚åœ°å€ã€‚

```javascript
// ç¯å¢ƒçš„åˆ‡æ¢
if (process.env.NODE_ENV == "development") {
  // ç”Ÿäº§ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.baidu.com";
} else if (process.env.NODE_ENV == "test") {
  // æµ‹è¯•ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.ceshi.com";
} else if (process.env.NODE_ENV == "production") {
  // æ­£å¼ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.production.com";
}
```

### è®¾ç½®è¯·æ±‚è¶…æ—¶

é€šè¿‡ `axios.defaults.timeout` è®¾ç½®é»˜è®¤çš„è¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚ä¾‹å¦‚è¶…è¿‡äº† 5sï¼Œå°±ä¼šå‘ŠçŸ¥ç”¨æˆ·å½“å‰è¯·æ±‚è¶…æ—¶ï¼Œè¯·åˆ·æ–°ç­‰ã€‚

```javascript
axios.defaults.timeout = 5000;
```

### post è¯·æ±‚å¤´çš„è®¾ç½®

`post` è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Šä¸€ä¸ªè¯·æ±‚å¤´ï¼Œæ‰€ä»¥å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œä¸€ä¸ªé»˜è®¤çš„è®¾ç½®ï¼Œå³è®¾ç½® `post` çš„è¯·æ±‚å¤´ä¸º `application/x-www-form-urlencoded;charset=UTF-8`

```javascript
axios.defaults.headers.post["Content-Type"] =
  "application/x-www-form-urlencoded;charset=UTF-8";
```

### è¯·æ±‚æ‹¦æˆªå™¨

æˆ‘ä»¬åœ¨å‘é€è¯·æ±‚å‰å¯ä»¥è¿›è¡Œä¸€ä¸ªè¯·æ±‚çš„æ‹¦æˆªï¼Œä¸ºä»€ä¹ˆè¦æ‹¦æˆªå‘¢ï¼Œæˆ‘ä»¬æ‹¦æˆªè¯·æ±‚æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿæ¯”å¦‚ï¼Œæœ‰äº›è¯·æ±‚æ˜¯éœ€è¦ç”¨æˆ·ç™»å½•ä¹‹åæ‰èƒ½è®¿é—®çš„ï¼Œæˆ–è€… `post` è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åºåˆ—åŒ–æˆ‘ä»¬æäº¤çš„æ•°æ®ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯·æ±‚è¢«å‘é€ä¹‹å‰è¿›è¡Œä¸€ä¸ªæ‹¦æˆªï¼Œä»è€Œè¿›è¡Œæˆ‘ä»¬æƒ³è¦çš„æ“ä½œã€‚

```javascript
// å…ˆå¯¼å…¥vuex,å› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨åˆ°é‡Œé¢çš„çŠ¶æ€å¯¹è±¡
// vuexçš„è·¯å¾„æ ¹æ®è‡ªå·±çš„è·¯å¾„å»å†™
import store from "@/store/index";

// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(
  (config) => {
    // æ¯æ¬¡å‘é€è¯·æ±‚ä¹‹å‰åˆ¤æ–­vuexä¸­æ˜¯å¦å­˜åœ¨token
    // å¦‚æœå­˜åœ¨ï¼Œåˆ™ç»Ÿä¸€åœ¨httpè¯·æ±‚çš„headeréƒ½åŠ ä¸Štokenï¼Œè¿™æ ·åå°æ ¹æ®tokenåˆ¤æ–­ä½ çš„ç™»å½•æƒ…å†µ
    // å³ä½¿æœ¬åœ°å­˜åœ¨tokenï¼Œä¹Ÿæœ‰å¯èƒ½tokenæ˜¯è¿‡æœŸçš„ï¼Œæ‰€ä»¥åœ¨å“åº”æ‹¦æˆªå™¨ä¸­è¦å¯¹è¿”å›çŠ¶æ€è¿›è¡Œåˆ¤æ–­
    const token = store.state.token;
    token && (config.headers.Authorization = token);
    return config;
  },
  (error) => {
    return Promise.error(error);
  }
);
```

::: tip
è¿™é‡Œè¯´ä¸€ä¸‹ `token`ï¼Œä¸€èˆ¬æ˜¯åœ¨ç™»å½•å®Œæˆä¹‹åï¼Œå°†ç”¨æˆ·çš„ `token` é€šè¿‡ `localStorage`æˆ–è€… `cookie` å­˜åœ¨æœ¬åœ°ï¼Œç„¶åç”¨æˆ·æ¯æ¬¡åœ¨è¿›å…¥é¡µé¢çš„æ—¶å€™ï¼ˆå³åœ¨ `main.js` ä¸­ï¼‰ï¼Œä¼šé¦–å…ˆä»æœ¬åœ°å­˜å‚¨ä¸­è¯»å– `token`ï¼Œå¦‚æœ `token` å­˜åœ¨è¯´æ˜ç”¨æˆ·å·²ç»ç™»é™†è¿‡ï¼Œåˆ™æ›´æ–° `vuex`ä¸­çš„ `token` çŠ¶æ€ã€‚ç„¶åï¼Œåœ¨æ¯æ¬¡è¯·æ±‚æ¥å£çš„æ—¶å€™ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚çš„ `header` ä¸­æºå¸¦ `token`ï¼Œåå°äººå‘˜å°±å¯ä»¥æ ¹æ®ä½ æºå¸¦çš„ `token` æ¥åˆ¤æ–­ä½ çš„ç™»å½•æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰æºå¸¦ï¼Œåˆ™è¯´æ˜æ²¡æœ‰ç™»å½•è¿‡ã€‚
:::

### å“åº”æ‹¦æˆªå™¨

```javascript
// å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
    response => {
        // å¦‚æœè¿”å›çš„çŠ¶æ€ç ä¸º200ï¼Œè¯´æ˜æ¥å£è¯·æ±‚æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸æ‹¿åˆ°æ•°æ®
        // å¦åˆ™çš„è¯æŠ›å‡ºé”™è¯¯
        if (response.status === 200) {
            return Promise.resolve(response);
        } else {
            return Promise.reject(response);
        }
    },
    // æœåŠ¡å™¨çŠ¶æ€ç ä¸æ˜¯2å¼€å¤´çš„çš„æƒ…å†µ
    // è¿™é‡Œå¯ä»¥è·Ÿä½ ä»¬çš„åå°å¼€å‘äººå‘˜åå•†å¥½ç»Ÿä¸€çš„é”™è¯¯çŠ¶æ€ç 
    // ç„¶åæ ¹æ®è¿”å›çš„çŠ¶æ€ç è¿›è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ç™»å½•è¿‡æœŸæç¤ºï¼Œé”™è¯¯æç¤ºç­‰ç­‰
    error => {
        if (error.response.status) {
            switch (error.response.status) {
                // 401: æœªç™»å½•
                // æœªç™»å½•åˆ™è·³è½¬ç™»å½•é¡µé¢ï¼Œå¹¶æºå¸¦å½“å‰é¡µé¢çš„è·¯å¾„
                // åœ¨ç™»å½•æˆåŠŸåè¿”å›å½“å‰é¡µé¢ï¼Œè¿™ä¸€æ­¥éœ€è¦åœ¨ç™»å½•é¡µæ“ä½œã€‚
                case 401:
                    router.replace({
                        path: '/login',
                        query: {
                            redirect: router.currentRoute.fullPath
                        }
                    });
                    break;

                // 403 tokenè¿‡æœŸ
                // ç™»å½•è¿‡æœŸå¯¹ç”¨æˆ·è¿›è¡Œæç¤º
                // æ¸…é™¤æœ¬åœ°tokenå’Œæ¸…ç©ºvuexä¸­tokenå¯¹è±¡
                // è·³è½¬ç™»å½•é¡µé¢
                case 403:
                     Message({
                        message: 'ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
                        type:'error',
                        duration: 1000,
                    });
                    // æ¸…é™¤token
                    localStorage.removeItem('token');
                    store.commit('loginSuccess', null);
                    // è·³è½¬ç™»å½•é¡µé¢ï¼Œå¹¶å°†è¦æµè§ˆçš„é¡µé¢fullPathä¼ è¿‡å»ï¼Œç™»å½•æˆåŠŸåè·³è½¬éœ€è¦è®¿é—®çš„é¡µé¢
                    setTimeout(() => {
                        router.replace({
                            path: '/login',
                            query: {
                                redirect: router.currentRoute.fullPath
                            }
                        });
                    }, 1000);
                    break;

                // 404è¯·æ±‚ä¸å­˜åœ¨
                case 404:
                    Message({
                        message: 'ç½‘ç»œè¯·æ±‚ä¸å­˜åœ¨',
                        type:'error',
                        duration: 1500,

                    });
                    break;
                // å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯æç¤º
                default:
                    Message({
                        message: error.response.data.message,
                        type: 'error',
                        duration: 1500
                    });
            }
            return Promise.reject(error.response);
        }
    }
});
```

å“åº”æ‹¦æˆªå™¨å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æœåŠ¡å™¨è¿”å›ç»™æˆ‘ä»¬çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨æ‹¿åˆ°ä¹‹å‰å¯ä»¥å¯¹ä»–è¿›è¡Œä¸€äº›å¤„ç†ã€‚ä¾‹å¦‚ä¸Šé¢çš„æ€æƒ³ï¼šå¦‚æœåå°è¿”å›çš„çŠ¶æ€ç æ˜¯ `200`ï¼Œåˆ™æ­£å¸¸è¿”å›æ•°æ®ï¼Œå¦åˆ™çš„æ ¹æ®é”™è¯¯çš„çŠ¶æ€ç ç±»å‹è¿›è¡Œä¸€äº›æˆ‘ä»¬éœ€è¦çš„é”™è¯¯ï¼Œå…¶å®è¿™é‡Œä¸»è¦å°±æ˜¯è¿›è¡Œäº†é”™è¯¯çš„ç»Ÿä¸€å¤„ç†å’Œæ²¡ç™»å½•æˆ–ç™»å½•è¿‡æœŸåè°ƒæ•´ç™»å½•é¡µçš„ä¸€ä¸ªæ“ä½œã€‚

### å°è£… get æ–¹æ³•å’Œ post æ–¹æ³•

æˆ‘ä»¬å¸¸ç”¨çš„ `ajax` è¯·æ±‚æ–¹æ³•æœ‰ `getã€postã€put` ç­‰æ–¹æ³•ã€‚`axios`å¯¹åº”çš„ä¹Ÿæœ‰å¾ˆå¤šç±»ä¼¼çš„æ–¹æ³•ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥çœ‹ä¸‹æ–‡æ¡£ã€‚ä½†æ˜¯ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å¯¹å…¶è¿›è¡Œä¸€ä¸ªç®€å•çš„å°è£…ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦å°è£…ä¸¤ä¸ªæ–¹æ³•ï¼š`get` å’Œ `post`ã€‚

- `get` æ–¹æ³•ï¼š
  æˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸€ä¸ª `get` å‡½æ•°ï¼Œ`get` å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæˆ‘ä»¬è¦è¯·æ±‚çš„ `url` åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬è¦æºå¸¦çš„è¯·æ±‚å‚æ•°ã€‚`get` å‡½æ•°è¿”å›ä¸€ä¸ª `promise` å¯¹è±¡ï¼Œå½“ `axios` å…¶è¯·æ±‚æˆåŠŸæ—¶ `resolve` æœåŠ¡å™¨è¿”å› å€¼ï¼Œè¯·æ±‚å¤±è´¥æ—¶ `reject` é”™è¯¯å€¼ã€‚æœ€åé€šè¿‡ `export` æŠ›å‡º `get` å‡½æ•°ã€‚

```javascript
/**
 * getæ–¹æ³•ï¼Œå¯¹åº”getè¯·æ±‚
 * @param {String} url [è¯·æ±‚çš„urlåœ°å€]
 * @param {Object} params [è¯·æ±‚æ—¶æºå¸¦çš„å‚æ•°]
 */
export function get(url, params) {
  return new Promise((resolve, reject) => {
    axios
      .get(url, {
        params: params,
      })
      .then((res) => {
        resolve(res.data);
      })
      .catch((err) => {
        reject(err.data);
      });
  });
}
```

- `post`æ–¹æ³•ï¼š
  åŸç†åŒ `get` åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œ`post` æ–¹æ³•å¿…é¡»è¦ä½¿ç”¨å¯¹æäº¤ä»å‚æ•°å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é€šè¿‡ `node` çš„ `qs` æ¨¡å—æ¥åºåˆ—åŒ–æˆ‘ä»¬çš„å‚æ•°ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œå¦‚æœæ²¡æœ‰åºåˆ—åŒ–æ“ä½œï¼Œåå°æ˜¯æ‹¿ä¸åˆ°ä½ æäº¤çš„æ•°æ®çš„ã€‚è¿™å°±æ˜¯æ–‡ç« å¼€å¤´æˆ‘ä»¬ `import QS from 'qs'`çš„åŸå› ã€‚

```javascript
/**
 * postæ–¹æ³•ï¼Œå¯¹åº”postè¯·æ±‚
 * @param {String} url [è¯·æ±‚çš„urlåœ°å€]
 * @param {Object} params [è¯·æ±‚æ—¶æºå¸¦çš„å‚æ•°]
 */
export function post(url, params) {
  return new Promise((resolve, reject) => {
    axios
      .post(url, QS.stringify(params))
      .then((res) => {
        resolve(res.data);
      })
      .catch((err) => {
        reject(err.data);
      });
  });
}
```

> è¿™é‡Œæœ‰ä¸ªå°ç»†èŠ‚è¯´ä¸‹ï¼Œ`axios.get()`æ–¹æ³•å’Œ `axios.post()`åœ¨æäº¤æ•°æ®æ—¶å‚æ•°çš„ä¹¦å†™æ–¹å¼è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚åŒºåˆ«å°±æ˜¯ï¼Œ`get`çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª`{}`ï¼Œç„¶åè¿™ä¸ªå¯¹è±¡çš„ `params` å±æ€§å€¼æ˜¯ä¸€ä¸ªå‚æ•°å¯¹è±¡çš„ã€‚è€Œ `post` çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ªå‚æ•°å¯¹è±¡ã€‚

### api æ¥å£ç»Ÿä¸€ç®¡ç†

åœ¨ `api.js` ä¸­å¼•å…¥å°è£…çš„ `get` å’Œ `post` æ–¹æ³•

```javascript
/**
 * apiæ¥å£ç»Ÿä¸€ç®¡ç†
 */
import { get, post } from "./http";
export const Login = (data) => post("api/v1/login", data);
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `Login` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•° `data`ï¼Œ`data` æ˜¯æˆ‘ä»¬è¯·æ±‚æ¥å£æ—¶æºå¸¦çš„å‚æ•°å¯¹è±¡ã€‚è€Œåè°ƒç”¨äº†æˆ‘ä»¬å°è£…çš„ `post` æ–¹æ³•ï¼Œ`post` æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„æ¥å£åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ `Login` çš„ `data` å‚æ•°ï¼Œå³è¯·æ±‚æ¥å£æ—¶æºå¸¦çš„å‚æ•°å¯¹è±¡ã€‚æœ€åé€šè¿‡ `export` å¯¼å‡º `Login`ã€‚

ç„¶ååœ¨æˆ‘ä»¬çš„é¡µé¢ä¸­å¯ä»¥è¿™æ ·è°ƒç”¨æˆ‘ä»¬çš„ `api` æ¥å£ï¼š

```javascript
import { apiAddress } from "@/request/api"; // å¯¼å…¥æˆ‘ä»¬çš„apiæ¥å£
export default {
  name: "Address",
  created() {
    this.onLoad();
  },
  methods: {
    // è·å–æ•°æ®
    onLoad() {
      // è°ƒç”¨apiæ¥å£ï¼Œå¹¶ä¸”æä¾›äº†ä¸¤ä¸ªå‚æ•°
      Login({
        userName: "admin",
        password: 123456,
      }).then((res) => {
        // è·å–æ•°æ®æˆåŠŸåçš„å…¶ä»–æ“ä½œ
      });
    },
  },
};
```

`api` æ¥å£ç®¡ç†çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæˆ‘ä»¬æŠŠ `api` ç»Ÿä¸€é›†ä¸­èµ·æ¥ï¼Œå¦‚æœåæœŸéœ€è¦ä¿®æ”¹æ¥å£ï¼Œæˆ‘ä»¬å°±ç›´æ¥åœ¨ `api.js` ä¸­æ‰¾åˆ°å¯¹åº”çš„ä¿®æ”¹å°±å¥½äº†ï¼Œè€Œä¸ç”¨å»æ¯ä¸€ä¸ªé¡µé¢æŸ¥æ‰¾æˆ‘ä»¬çš„æ¥å£ç„¶åå†ä¿®æ”¹ä¼šå¾ˆéº»çƒ¦ã€‚è¿˜æœ‰å°±æ˜¯å¦‚æœç›´æ¥åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¿®æ”¹æ¥å£ï¼Œä¸€ä¸å°å¿ƒè¿˜å®¹æ˜“åŠ¨åˆ°æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç é€ æˆä¸å¿…è¦çš„éº»çƒ¦ã€‚

---

## å®Œæ•´ axios å°è£…ä»£ç 

```javascript
/**axioså°è£…
 * è¯·æ±‚æ‹¦æˆªã€ç›¸åº”æ‹¦æˆªã€é”™è¯¯ç»Ÿä¸€å¤„ç†
 */
import axios from "axios";
import QS from "qs";
import { Message } from "element-ui";
import store from "../store/index";

// ç¯å¢ƒçš„åˆ‡æ¢
if (process.env.NODE_ENV == "development") {
  // ç”Ÿäº§ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.baidu.com";
} else if (process.env.NODE_ENV == "test") {
  // æµ‹è¯•ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.ceshi.com";
} else if (process.env.NODE_ENV == "production") {
  // æ­£å¼ç¯å¢ƒ
  axios.defaults.baseURL = "https://www.production.com";
}

// è¯·æ±‚è¶…æ—¶æ—¶é—´
axios.defaults.timeout = 5000;

// postè¯·æ±‚å¤´
axios.defaults.headers.post["Content-Type"] =
  "application/x-www-form-urlencoded;charset=UTF-8";

// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(
  (config) => {
    // æ¯æ¬¡å‘é€è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å­˜åœ¨tokenï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç»Ÿä¸€åœ¨httpè¯·æ±‚çš„headeréƒ½åŠ ä¸Štokenï¼Œä¸ç”¨æ¯æ¬¡è¯·æ±‚éƒ½æ‰‹åŠ¨æ·»åŠ äº†
    // å³ä½¿æœ¬åœ°å­˜åœ¨tokenï¼Œä¹Ÿæœ‰å¯èƒ½tokenæ˜¯è¿‡æœŸçš„ï¼Œæ‰€ä»¥åœ¨å“åº”æ‹¦æˆªå™¨ä¸­è¦å¯¹è¿”å›çŠ¶æ€è¿›è¡Œåˆ¤æ–­
    const token = store.state.token;
    token && (config.headers.Authorization = token);
    return config;
  },
  (error) => {
    return Promise.error(error);
  }
);

// å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  (response) => {
    if (response.status === 200) {
      return Promise.resolve(response);
    } else {
      return Promise.reject(response);
    }
  },
  // æœåŠ¡å™¨çŠ¶æ€ç ä¸æ˜¯200çš„æƒ…å†µ
  (error) => {
    if (error.response.status) {
      switch (error.response.status) {
        // 401: æœªç™»å½•
        // æœªç™»å½•åˆ™è·³è½¬ç™»å½•é¡µé¢ï¼Œå¹¶æºå¸¦å½“å‰é¡µé¢çš„è·¯å¾„
        // åœ¨ç™»å½•æˆåŠŸåè¿”å›å½“å‰é¡µé¢ï¼Œè¿™ä¸€æ­¥éœ€è¦åœ¨ç™»å½•é¡µæ“ä½œã€‚
        case 401:
          router.replace({
            path: "/login",
            query: { redirect: router.currentRoute.fullPath },
          });
          break;
        // 403 tokenè¿‡æœŸ
        // ç™»å½•è¿‡æœŸå¯¹ç”¨æˆ·è¿›è¡Œæç¤º
        // æ¸…é™¤æœ¬åœ°tokenå’Œæ¸…ç©ºvuexä¸­tokenå¯¹è±¡
        // è·³è½¬ç™»å½•é¡µé¢
        case 403:
          Message({
            message: "ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",
            type: "error",
            duration: 1000,
          });
          // æ¸…é™¤token
          localStorage.removeItem("token");
          store.commit("loginSuccess", null);
          // è·³è½¬ç™»å½•é¡µé¢ï¼Œå¹¶å°†è¦æµè§ˆçš„é¡µé¢fullPathä¼ è¿‡å»ï¼Œç™»å½•æˆåŠŸåè·³è½¬éœ€è¦è®¿é—®çš„é¡µé¢
          setTimeout(() => {
            router.replace({
              path: "/login",
              query: {
                redirect: router.currentRoute.fullPath,
              },
            });
          }, 1000);
          break;
        // 404è¯·æ±‚ä¸å­˜åœ¨
        case 404:
          Message({
            message: "ç½‘ç»œè¯·æ±‚ä¸å­˜åœ¨",
            type: "error",
            duration: 1500,
          });
          break;
        // å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯æç¤º
        default:
          Message({
            message: error.response.data.message,
            type: "error",
            duration: 1500,
          });
      }
      return Promise.reject(error.response);
    }
  }
);
/**
 * getæ–¹æ³•ï¼Œå¯¹åº”getè¯·æ±‚
 * @param {String} url [è¯·æ±‚çš„urlåœ°å€]
 * @param {Object} params [è¯·æ±‚æ—¶æºå¸¦çš„å‚æ•°]
 */
export function get(url, params) {
  return new Promise((resolve, reject) => {
    axios
      .get(url, {
        params: params,
      })
      .then((res) => {
        resolve(res.data);
      })
      .catch((err) => {
        reject(err.data);
      });
  });
}
/**
 * postæ–¹æ³•ï¼Œå¯¹åº”postè¯·æ±‚
 * @param {String} url [è¯·æ±‚çš„urlåœ°å€]
 * @param {Object} params [è¯·æ±‚æ—¶æºå¸¦çš„å‚æ•°]
 */
export function post(url, params) {
  return new Promise((resolve, reject) => {
    axios
      .post(url, QS.stringify(params))
      .then((res) => {
        resolve(res.data);
      })
      .catch((err) => {
        reject(err.data);
      });
  });
}
```

## æ ¹æ®éœ€æ±‚ä¸åŒä½œä¼˜åŒ–

1.  ä¼˜åŒ– `axios` å°è£…ï¼Œå»æ‰ä¹‹å‰çš„ `get` å’Œ `post`
2.  æ–­ç½‘æƒ…å†µå¤„ç†
3.  æ›´åŠ æ¨¡å—åŒ–çš„ `api` ç®¡ç†
4.  æ¥å£åŸŸåæœ‰å¤šä¸ªçš„æƒ…å†µ
5.  `api` æŒ‚è½½åˆ° `vue.prototype` ä¸Šçœå»å¼•å…¥çš„æ­¥éª¤

`http.js` ä¸­ `axios` å°è£…çš„ä¼˜åŒ–ï¼Œå…ˆç›´æ¥è´´ä»£ç ï¼š

```javascript
/**
 * axioså°è£…
 * è¯·æ±‚æ‹¦æˆªã€å“åº”æ‹¦æˆªã€é”™è¯¯ç»Ÿä¸€å¤„ç†
 */
import axios from "axios";
import router from "../router";
import store from "../store/index";
import { Message } from "element-ui";

/**
 * æç¤ºå‡½æ•°
 * ç¦æ­¢ç‚¹å‡»è’™å±‚ã€æ˜¾ç¤ºä¸€ç§’åå…³é—­
 */
const tip = (msg) => {
  Message({
    message: msg,
    type: "error",
    duration: 1000,
  });
};

/**
 * è·³è½¬ç™»å½•é¡µ
 * æºå¸¦å½“å‰é¡µé¢è·¯ç”±ï¼Œåœ¨ç™»å½•é¡µé¢å®Œæˆç™»å½•åè¿”å›å½“å‰é¡µé¢
 */
const toLogin = () => {
  router.replace({
    path: "/login",
    query: {
      redirect: router.currentRoute.fullPath,
    },
  });
};

/**
 * è¯·æ±‚å¤±è´¥åçš„é”™è¯¯ç»Ÿä¸€å¤„ç†
 * @param {Number} status è¯·æ±‚å¤±è´¥çš„çŠ¶æ€ç 
 */
const errorHandle = (status, other) => {
  // çŠ¶æ€ç åˆ¤æ–­
  switch (status) {
    // 401: æœªç™»å½•çŠ¶æ€ï¼Œè·³è½¬ç™»å½•é¡µ
    case 401:
      toLogin();
      break;
    // 403 tokenè¿‡æœŸ
    // æ¸…é™¤tokenå¹¶è·³è½¬ç™»å½•é¡µ
    case 403:
      tip("ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
      localStorage.removeItem("token");
      store.commit("loginSuccess", null);
      setTimeout(() => {
        toLogin();
      }, 1000);
      break;
    // 404è¯·æ±‚ä¸å­˜åœ¨
    case 404:
      tip("è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨");
      break;
    default:
      console.log(other);
  }
};

// åˆ›å»ºaxioså®ä¾‹
var instance = axios.create({ timeout: 5000 });
// è®¾ç½®postè¯·æ±‚å¤´
instance.defaults.headers.post["Content-Type"] =
  "application/x-www-form-urlencoded";
/**
 * è¯·æ±‚æ‹¦æˆªå™¨
 * æ¯æ¬¡è¯·æ±‚å‰ï¼Œå¦‚æœå­˜åœ¨tokenåˆ™åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦token
 */
instance.interceptors.request.use(
  (config) => {
    // ç™»å½•æµç¨‹æ§åˆ¶ä¸­ï¼Œæ ¹æ®æœ¬åœ°æ˜¯å¦å­˜åœ¨tokenåˆ¤æ–­ç”¨æˆ·çš„ç™»å½•æƒ…å†µ
    // ä½†æ˜¯å³ä½¿tokenå­˜åœ¨ï¼Œä¹Ÿæœ‰å¯èƒ½tokenæ˜¯è¿‡æœŸçš„ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡çš„è¯·æ±‚å¤´ä¸­æºå¸¦token
    // åå°æ ¹æ®æºå¸¦çš„tokenåˆ¤æ–­ç”¨æˆ·çš„ç™»å½•æƒ…å†µï¼Œå¹¶è¿”å›ç»™æˆ‘ä»¬å¯¹åº”çš„çŠ¶æ€ç 
    // è€Œåæˆ‘ä»¬å¯ä»¥åœ¨å“åº”æ‹¦æˆªå™¨ä¸­ï¼Œæ ¹æ®çŠ¶æ€ç è¿›è¡Œä¸€äº›ç»Ÿä¸€çš„æ“ä½œã€‚
    const token = store.state.token;
    token && (config.headers.Authorization = token);
    return config;
  },
  (error) => Promise.error(error)
);

// å“åº”æ‹¦æˆªå™¨
instance.interceptors.response.use(
  // è¯·æ±‚æˆåŠŸ
  (res) => (res.status === 200 ? Promise.resolve(res) : Promise.reject(res)),
  // è¯·æ±‚å¤±è´¥
  (error) => {
    const { response } = error;
    if (response) {
      // è¯·æ±‚å·²å‘å‡ºï¼Œä½†æ˜¯ä¸åœ¨2xxçš„èŒƒå›´
      errorHandle(response.status, response.data.message);
      return Promise.reject(response);
    } else {
      // å¤„ç†æ–­ç½‘çš„æƒ…å†µ
      // eg:è¯·æ±‚è¶…æ—¶æˆ–æ–­ç½‘æ—¶ï¼Œæ›´æ–°stateçš„networkçŠ¶æ€
      // networkçŠ¶æ€åœ¨app.vueä¸­æ§åˆ¶ç€ä¸€ä¸ªå…¨å±€çš„æ–­ç½‘æç¤ºç»„ä»¶çš„æ˜¾ç¤ºéšè—
      // å…³äºæ–­ç½‘ç»„ä»¶ä¸­çš„åˆ·æ–°é‡æ–°è·å–æ•°æ®ï¼Œä¼šåœ¨æ–­ç½‘ç»„ä»¶ä¸­è¯´æ˜
      if (!window.navigator.onLine) {
        store.commit("changeNetwork", false);
      } else {
        return Promise.reject(error);
      }
    }
  }
);

export default instance;
```

::: note
å¦‚ä¸‹å‡ ç‚¹æ”¹å˜ï¼š

1. å»æ‰äº†ä¹‹å‰ `get` å’Œ `post` æ–¹æ³•çš„å°è£…ï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ª `axios` å®ä¾‹ç„¶å `export default` æ–¹æ³•å¯¼å‡ºï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥æ›´çµæ´»ä¸€äº›ã€‚
2. å»æ‰äº†é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ `baseUrl` çš„å€¼ã€‚è€ƒè™‘åˆ°æ¥å£ä¼šæœ‰å¤šä¸ªä¸åŒåŸŸåçš„æƒ…å†µï¼Œæ‰€ä»¥å‡†å¤‡é€šè¿‡ js å˜é‡æ¥æ§åˆ¶æ¥å£åŸŸåã€‚è¿™ç‚¹å…·ä½“åœ¨ `api` é‡Œä¼šä»‹ç»ã€‚
3. å¢åŠ äº†è¯·æ±‚è¶…æ—¶ï¼Œå³æ–­ç½‘çŠ¶æ€çš„å¤„ç†ã€‚
   å½“æ–­ç½‘æ—¶ï¼Œé€šè¿‡æ›´æ–° `vuex` ä¸­ `network`çš„çŠ¶æ€æ¥æ§åˆ¶æ–­ç½‘æç¤ºç»„ä»¶çš„æ˜¾ç¤ºéšè—ã€‚æ–­ç½‘æç¤ºä¸€èˆ¬ä¼šæœ‰é‡æ–°åŠ è½½æ•°æ®çš„æ“ä½œã€‚
4. å…¬ç”¨å‡½æ•°è¿›è¡ŒæŠ½å‡ºï¼Œç®€åŒ–ä»£ç ï¼Œå°½é‡ä¿è¯å•ä¸€èŒè´£åŸåˆ™ã€‚
   ä¸‹é¢è¯´ä¸‹ `api` è¿™å—ï¼Œè€ƒè™‘åˆ°ä»¥ä¸‹éœ€æ±‚ï¼š
5. æ›´åŠ æ¨¡å—åŒ–
6. æ›´æ–¹ä¾¿å¤šäººå¼€å‘ï¼Œæœ‰æ•ˆå‡å°‘è§£å†³å‘½åå†²çª
7. å¤„ç†æ¥å£åŸŸåæœ‰å¤šä¸ªæƒ…å†µ
:::
è¿™é‡Œæ–°å»ºäº†ä¸€ä¸ª `api` æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª `index.js` å’Œä¸€ä¸ª `base.js`ï¼Œä»¥åŠå¤šä¸ªæ ¹æ®æ¨¡å—åˆ’åˆ†çš„æ¥å£ js æ–‡ä»¶ã€‚`index.js` æ˜¯ä¸€ä¸ª `api` çš„å‡ºå£ï¼Œ`base.js` ç®¡ç†æ¥å£åŸŸåï¼Œå…¶ä»– js åˆ™ç”¨æ¥ç®¡ç†å„ä¸ªæ¨¡å—çš„æ¥å£ã€‚

å…ˆæ”¾ `index.js` ä»£ç ï¼š

```javascript
/**
 * apiæ¥å£çš„ç»Ÿä¸€å‡ºå£
 */
// æ–‡ç« æ¨¡å—æ¥å£
import article from "@/api/article";
// å…¶ä»–æ¨¡å—çš„æ¥å£â€¦â€¦

// å¯¼å‡ºæ¥å£
export default {
  article,
  // â€¦â€¦
};
```

`index.js`æ˜¯ä¸€ä¸ª `api` æ¥å£çš„å‡ºå£ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠ `api` æ¥å£æ ¹æ®åŠŸèƒ½åˆ’åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œåˆ©äºå¤šäººåä½œå¼€å‘ï¼Œæ¯”å¦‚ä¸€ä¸ªäººåªè´Ÿè´£ä¸€ä¸ªæ¨¡å—çš„å¼€å‘ç­‰ï¼Œè¿˜èƒ½æ–¹ä¾¿æ¯ä¸ªæ¨¡å—ä¸­æ¥å£çš„å‘½åã€‚

`base.js`:

```javascript
/**
 * æ¥å£åŸŸåçš„ç®¡ç†
 */
const base = {
  sq: "https://xxxx111111.com/api/v1",
  bd: "http://xxxxx22222.com/api",
};

export default base;
```

é€šè¿‡ `base.js` æ¥`ç®¡ç†æˆ‘ä»¬çš„æ¥å£åŸŸåï¼Œä¸ç®¡æœ‰å¤šå°‘ä¸ªéƒ½å¯ä»¥é€šè¿‡è¿™é‡Œè¿›è¡Œæ¥å£çš„å®šä¹‰ã€‚å³ä½¿ä¿®æ”¹èµ·æ¥ï¼Œä¹Ÿæ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚
æœ€åå°±æ˜¯æ¥å£æ¨¡å—çš„è¯´æ˜ï¼Œä¾‹å¦‚ä¸Šé¢çš„ `article.js`:

```javascript
/**
 * articleæ¨¡å—æ¥å£åˆ—è¡¨
 */

import base from "./base"; // å¯¼å…¥æ¥å£åŸŸååˆ—è¡¨
import axios from "@/utils/http"; // å¯¼å…¥httpä¸­åˆ›å»ºçš„axioså®ä¾‹
import qs from "qs"; // æ ¹æ®éœ€æ±‚æ˜¯å¦å¯¼å…¥qsæ¨¡å—

const article = {
  // æ–°é—»åˆ—è¡¨
  articleList() {
    return axios.get(`${base.sq}/topics`);
  },
  // æ–°é—»è¯¦æƒ…,æ¼”ç¤º
  articleDetail(id, params) {
    return axios.get(`${base.sq}/topic/${id}`, {
      params: params,
    });
  },
  // postæäº¤
  login(params) {
    return axios.post(`${base.sq}/accesstoken`, qs.stringify(params));
  },
  // å…¶ä»–æ¥å£â€¦â€¦â€¦â€¦
};

export default article;
```


::: note
1. é€šè¿‡ç›´æ¥å¼•å…¥æˆ‘ä»¬å°è£…å¥½çš„ `axios` å®ä¾‹ï¼Œç„¶åå®šä¹‰æ¥å£ã€è°ƒç”¨ `axios` å®ä¾‹å¹¶è¿”å›ï¼Œå¯ä»¥æ›´çµæ´»çš„ä½¿ç”¨ `axios`ï¼Œæ¯”å¦‚ä½ å¯ä»¥å¯¹ `post` è¯·æ±‚æ—¶æäº¤çš„æ•°æ®è¿›è¡Œä¸€ä¸ª `qs` åºåˆ—åŒ–çš„å¤„ç†ç­‰ã€‚
2. è¯·æ±‚çš„é…ç½®æ›´çµæ´»ï¼Œä½ å¯ä»¥é’ˆå¯¹æŸä¸ªéœ€æ±‚è¿›è¡Œä¸€ä¸ªä¸åŒçš„é…ç½®ã€‚å…³äºé…ç½®çš„ä¼˜å…ˆçº§ï¼Œ`axios` æ–‡æ¡£è¯´çš„å¾ˆæ¸…æ¥šï¼Œè¿™ä¸ªé¡ºåºæ˜¯ï¼šåœ¨ `lib/defaults.js` æ‰¾åˆ°çš„åº“çš„é»˜è®¤å€¼ï¼Œç„¶åæ˜¯å®ä¾‹çš„ `defaults` å±æ€§ï¼Œæœ€åæ˜¯è¯·æ±‚çš„ `config` å‚æ•°ã€‚åè€…å°†ä¼˜å…ˆäºå‰è€…ã€‚
3. `restful` é£æ ¼çš„æ¥å£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼çµæ´»çš„è®¾ç½® `api` æ¥å£åœ°å€ã€‚
:::

æœ€åï¼Œä¸ºäº†æ–¹ä¾¿ `api` çš„è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æŒ‚è½½åˆ° `vue`çš„åŸå‹ä¸Šã€‚åœ¨ `main.js` ä¸­ï¼š

```javascript
import Vue from "vue";
import App from "./App";
import router from "./router"; // å¯¼å…¥è·¯ç”±æ–‡ä»¶
import store from "./store"; // å¯¼å…¥vuexæ–‡ä»¶
import api from "./api"; // å¯¼å…¥apiæ¥å£

Vue.prototype.$api = api; // å°†apiæŒ‚è½½åˆ°vueçš„åŸå‹ä¸Š
```

åœ¨é¡µé¢ä¸­è¿™æ ·è°ƒç”¨æ¥å£ï¼Œä¾‹å­ ğŸŒ°ï¼š

```javascript
methods: {
    onLoad(id) {
        this.$api.article.articleDetail(id, {
            api: 123
        }).then(res=> {
            // æ‰§è¡ŒæŸäº›æ“ä½œ
        })
    }
}
```

å…³äºæ–­ç½‘çš„å¤„ç†ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ ğŸŒ°ï¼š

```html
<template>
  <div id="app">
    <div v-if="!network">
      <h3>æˆ‘æ²¡ç½‘äº†</h3>
      <div @click="onRefresh">åˆ·æ–°</div>
    </div>
    <router-view />
  </div>
</template>

<script>
  import { mapState } from "vuex";
  export default {
    name: "App",
    computed: {
      ...mapState(["network"]),
    },
    methods: {
      // é€šè¿‡è·³è½¬ä¸€ä¸ªç©ºé¡µé¢å†è¿”å›çš„æ–¹å¼æ¥å®ç°åˆ·æ–°å½“å‰é¡µé¢æ•°æ®çš„ç›®çš„
      onRefresh() {
        this.$router.replace("/refresh");
      },
    },
  };
</script>
```

è¿™æ˜¯ `app.vue`ï¼Œè¿™é‡Œç®€å•æ¼”ç¤ºä¸€ä¸‹æ–­ç½‘ã€‚åœ¨ `http.js` ä¸­ä»‹ç»äº†ï¼Œæˆ‘ä»¬ä¼šåœ¨æ–­ç½‘çš„æ—¶å€™ï¼Œæ¥æ›´æ–° `vue` ä¸­ `network`çš„çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬æ ¹æ® `network` çš„çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½è¿™ä¸ªæ–­ç½‘ç»„ä»¶ã€‚æ–­ç½‘æƒ…å†µä¸‹ï¼ŒåŠ è½½æ–­ç½‘ç»„ä»¶ï¼Œä¸åŠ è½½å¯¹åº”é¡µé¢çš„ç»„ä»¶ã€‚å½“ç‚¹å‡»åˆ·æ–°çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡è·³è½¬ `refesh` é¡µé¢ç„¶åç«‹å³è¿”å›çš„æ–¹å¼æ¥å®ç°é‡æ–°è·å–æ•°æ®çš„æ“ä½œã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ª `refresh.vue` é¡µé¢ï¼Œå¹¶åœ¨å…¶ `beforeRouteEnter` é’©å­ä¸­å†è¿”å›å½“å‰é¡µé¢ã€‚

```javascript
// refresh.vue
beforeRouteEnter (to, from, next) {
    next(vm => {
        vm.$router.replace(from.fullPath)
    })
}
```
